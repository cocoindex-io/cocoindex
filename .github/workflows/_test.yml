name: Run Tests (INTERNAL)

on:
    workflow_call:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
    build-test:
        strategy:
            matrix:
                python-version: [3.11]
                platform:
                  - { runner: ubuntu-latest, python_exec: ".venv/bin/python" }
                  - { runner: ubuntu-24.04-arm, python_exec: ".venv/bin/python" }
                  - { runner: macos-latest, python_exec: ".venv/bin/python", extra_rustflags: "-C split-debuginfo=off"}
                  - { runner: macos-15-intel, python_exec: ".venv/bin/python", extra_rustflags: "-C split-debuginfo=off"}
                  - { runner: windows-latest, python_exec: ".venv\\Scripts\\python" }
        runs-on: ${{ matrix.platform.runner }}
        env:
          RUSTFLAGS: "-C debuginfo=0 ${{ matrix.platform.extra_rustflags }}"
          CARGO_INCREMENTAL: "0"
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"

        steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 1

        - name: Run sccache-cache
          uses: mozilla-actions/sccache-action@v0.0.9

        - uses: actions/setup-python@v5
          id: setup_python
          with:
            python-version: ${{ matrix.python-version }}
            # Python cache is huge and saves little time, so disabled for now, until we have higher cache size limits
            # cache: 'pip'

        - run: rustup toolchain install stable --profile minimal

        # Disable Rust cache until we have higher cache size limits
        # - name: Rust Cache
        #   uses: Swatinem/rust-cache@v2
        #   with:
        #     key: rust-${{ matrix.platform.runner }}-${{ matrix.python-version }}
        #     cache-targets: 'false'
        #     cache-all-crates: 'false'
        #     cache-workspace-crates: 'false'

        - name: Rust tests (no default features)
          run: cargo test --no-default-features --verbose

        - name: Rust tests
          run: cargo test --verbose

        - name: Setup venv
          run: |
            python -m venv .venv
        - name: Install Python toolchains
          run: |
            ${{ matrix.platform.python_exec }} -m pip install maturin
        - name: Python build
          run: |
            ${{ matrix.platform.python_exec }} -m maturin develop --strip -E all-ci
        - name: Python type check (mypy)
          run: |
            ${{ matrix.platform.python_exec }} -m mypy python
        - name: Python tests
          run: |
            ${{ matrix.platform.python_exec }} -m pytest --capture=no python/cocoindex/tests

    build-test-free-threaded:
        runs-on: ubuntu-latest
        env:
          RUSTFLAGS: "-C debuginfo=0"
          CARGO_INCREMENTAL: "0"
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"

        steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 1

        - name: Run sccache-cache
          uses: mozilla-actions/sccache-action@v0.0.9

        - name: Setup Python (3.14 free-threaded)
          uses: actions/setup-python@v5
          with:
            python-version: '3.14'
            allow-prereleases: true
            freethreaded: true

        - name: Verify interpreter configuration
          run: |
            python - <<'PY'
import sys
import sysconfig

print(f"Python version: {sys.version}")
print(f"GIL enabled? {getattr(sys, '_is_gil_enabled', 'missing')}")
print(f"SOABI: {sysconfig.get_config_var('SOABI')}")
if not hasattr(sys, '_is_gil_enabled') or sys._is_gil_enabled():
    raise SystemExit("Free-threaded interpreter with disabled GIL is required")
PY

        - run: rustup toolchain install stable --profile minimal

        - name: Rust tests (no default features)
          run: cargo test --no-default-features --verbose

        - name: Rust tests
          run: cargo test --verbose

        - name: Setup venv
          run: |
            python -m venv .venv

        - name: Install Python toolchains
          run: |
            .venv/bin/python -m pip install --upgrade pip
            .venv/bin/python -m pip install maturin

        - name: Python build (free-threaded)
          run: |
            .venv/bin/python -m maturin develop --no-default-features -F free-threaded --strip -E all-ci,free-threaded

        - name: Verify CocoIndex in free-threaded mode
          run: |
            .venv/bin/python - <<'PY'
import sys
import sysconfig
import cocoindex

print(f"CocoIndex version: {cocoindex.__version__}")
print(f"GIL enabled? {getattr(sys, '_is_gil_enabled', 'missing')}")
print(f"SOABI: {sysconfig.get_config_var('SOABI')}")
if sys._is_gil_enabled():
    raise SystemExit("Expected free-threaded interpreter with disabled GIL")
PY

        - name: Python type check (mypy)
          run: |
            .venv/bin/python -m mypy python

        - name: Python tests (free-threaded)
          run: |
            .venv/bin/python -m pytest --capture=no python/cocoindex/tests

    validate-3p-notices:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 1
        - name: Install Rust toolchain
          uses: dtolnay/rust-toolchain@stable
        - uses: taiki-e/install-action@v2
          with:
            tool: cargo-binstall
        - name: Install cargo-about
          run: cargo binstall -y cargo-about
        - name: Validate third-party notices (dry-run)
          shell: bash
          run: |
            set +e
            cargo about generate about.hbs > /dev/null
            status=$?
            if [ $status -ne 0 ]; then
              echo "::error::Third-party notices validation failed. Please update /about.toml and rerun."
              exit $status
            fi
