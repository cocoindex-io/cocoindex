name: Run Tests

on:
    workflow_call:

env:
  CARGO_TERM_COLOR: always

jobs:
    rust:
        strategy:
            matrix:
                python-version: [3.11, 3.13]
                platform: [ubuntu-latest, macos-latest]
        runs-on: ${{ matrix.platform }}
        steps:
        - uses: actions/checkout@v4

        - run: rustup toolchain install stable --profile minimal
        - name: Rust Cache
          uses: Swatinem/rust-cache@v2.7.3
        - name: Rust build
          run: cargo build --verbose
        - name: Rust tests
          run: cargo test --verbose

        - uses: actions/setup-python@v5
          with:
            python-version: ${{ matrix.python-version }}
            cache: 'pip'
        - name: Install Python global dependencies
          run: |
            pip install maturin pytest
        - uses: actions/cache@v4
          with:
            path: .venv
            key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
            restore-keys: |
              ${{ runner.os }}-python-${{ matrix.python-version }}-
        - name: Python build & test
          run: |
            python -m venv .venv
            source .venv/bin/activate
            maturin develop
            pytest python/cocoindex/tests